project:
    dependencies:
        - github: https://github.com/SalesforceFoundation/Cumulus
        - github: https://github.com/SalesforceFoundation/HEDAP
    name: Advancement
    package:
        name: Gift Entry Manager
        namespace: gem0
        api_version: 42.0
    git:
        prefix_release: rel/gem0/
        prefix_beta: beta/gem0/
        repo_url: https://github.com/SalesforceFoundation/gem

tasks:
    deploy_abacus_settings:
        description: Configure the default Abacus Settings for Gift Processing
        class_path: tasks.anon_apex.AnonymousApexFromFileTask
        options:
            path: dev_config/scripts/configure_abacus_settings.cls
            method: initializeAbacusSettings();

    deploy_dev_config:
        description: Deploys configuration for Development. Assigns page layouts, compact layouts, and sets tab visibilities. Record type visibilities are set the update_admin_profile task
        class_path: cumulusci.tasks.salesforce.DeployBundles
        options:
            namespace_inject: $project_config.project__package__namespace
            path: dev_config/src
            unmanaged: True

    deploy_dev_config_delete:
        description: Removes Development configuration. Sets page layouts, compact layouts to system defaults. Removes record type visibilites.
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: dev_config/delete

    execute_install_apex:
        description: Runs most of the install script methods from Post_Install_Script class
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            apex: >
                Post_Install_Script.giftSetup();
                Post_Install_Script.populateNPSPAccountModel();

    test_data_dev_org:
        description: 'Loads a test data set for most NPSP objects based on 100 Contacts that should fit into a scratch org or DE org'
        class_path: cumulusci.tasks.bulkdata.LoadData
        options:
            database_url: 'sqlite:///testdata/dev_org/test_data.db'
            mapping: 'testdata/mapping.yml'

    test_data_delete:
        description: 'WARNING: Deletes all data in the objects specified in the objects option.'
        class_path: cumulusci.tasks.bulkdata.DeleteData
        options:
            objects:
                - Opportunity
                - npe03__Recurring_Donation__c
                - Case
                - Contact
                - Account
                - npsp__Allocation__c
                - npsp__General_Accounting_Unit__c
                - Campaign

    test_data_default_settings:
        description: Configure the default NPSP Settings for Gift Processing
        class_path: tasks.anon_apex.AnonymousApexFromFileTask
        options:
            path: dev_config/scripts/configure_default_settings.cls
            method: setupGEMDefaults();

    test_data_user_setup:
        description: Sets up Gift Processing Users with correct Profiles
        class_path: tasks.anon_apex.AnonymousApexFromFileTask
        options:
            path: dev_config/scripts/configure_default_settings.cls
            method: AddGiftProcessor();

    publish_installer:
        class_path: cumulusci.tasks.metadeploy.Publish
        options:
            product_id: DBL2xmV
            flow: install_pilot
            title: Install Pilot
            description: Installs the Gift Entry Manager pilot
            slug: pilot
            tier: primary
            group: Release Management
            preflight_message: Gift Entry Manager (GEM)
            post_install_message: |
                Thanks for installing Gift Entry Manager (GEM)!

                Please post any feedback in the Power of Us Hub (<https://sfdc.co/bjJ33p>). Your feedback is valued and will help us improve the product.
flows:
    config_apextest:
        steps:
            3:
                task: deploy_dev_config

    config_dev:
        steps:
            3:
                task: deploy_dev_config_delete
            4:
                task: deploy_dev_config
            5:
                flow: test_data_setup

    config_qa:
        steps:
            2:
                task: None
            3:
                task: deploy_dev_config_delete
            4:
                task: deploy_dev_config
            5:
                task: update_admin_profile
            6:
                flow: test_data_setup
            7:
                flow: test_data_dev_org

    config_managed:
        steps:
            3:
                task: deploy_dev_config
                options:
                    unmanaged: False
    ci_feature:
        steps:
            7.1:
                task: run_tests
                options:
                   managed: True
                   namespace: hed
            7.2:
                task: run_tests
                options:
                    managed: True
                    namespace: npsp

    ci_feature_beta_deps:
        description: When run, the latest version (including betas) of Cumulus and HEDA are installed, and all tests are run.
        steps:
            5:
                task: run_tests
                options:
                   managed: True
                   namespace: hed
            6:
                task: run_tests
                options:
                    managed: True
                    namespace: npsp

    dev_org_beta_deps:
        description: Set up an org as a development environment for unmanaged metadata based on the latest version (including betas).
        steps:
            1:
                flow: beta_dependencies
            2:
                flow: deploy_unmanaged
            3:
                flow: config_dev

    test_data_setup:
        description: 'WARNING: This flow deletes all data first, then loads the complete test data set based on 100 Contacts into the target org.'
        steps:
            1:
                task: test_data_default_settings
            2:
                task: test_data_user_setup
            3:
                task: execute_install_apex

    test_data_dev_org:
        description: 'WARNING: This flow deletes all data first, then loads the complete test data set based on 100 Contacts into the target org.'
        steps:
            1:
                task: test_data_delete
            2:
                task: test_data_dev_org

    install_pilot:
      steps:
          1:
              task: update_dependencies
              options:
                  dependencies:
                      - github: https://github.com/SalesforceFoundation/Cumulus
                      - github: https://github.com/SalesforceFoundation/HEDAP
                      - github: https://github.com/SalesforceFoundation/Abacus
          2:
              task: deploy_pre
          3:
              task: install_managed
          4:
              flow: config_managed
          5:
              flow: install_pilot_settings

    install_pilot_settings:
        steps:
            1:
                task: test_data_default_settings
                options:
                    managed: True
            2:
                task: deploy_abacus_settings
                options:
                    managed: True


orgs:
    scratch:
        dev_namespaced:
            config_file: orgs/dev.json
            namespaced: True

        dev_prerelease:
            config_file: orgs/dev_prerelease.json
